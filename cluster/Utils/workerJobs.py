from Utils.tongManager import TongManager
from Utils.apkNoMainManager import ApkNoMainManager
from Utils.Libs.jobs import downloadAPKs,unzipAPKs,decodeManifest,renameDex,importDex,AnalyzeDex,cleanFolders,cleanApks


def work(tongManager,apkNoMainManager,core_index,pathDex):

    shaList = tongManager.pop()
    shaDownloaded = [False for sha in shaList]
        
   
    while(shaList != None):
        print(core_index, shaList)

        # download apks from AndroZoo
        while(not all(shaDownloaded)):
            shaDownloaded = downloadAPKs(shaList,shaDownloaded)
            print(shaDownloaded)

        shaDownloaded = [False for sha in shaList]

        # unzip the apks
        # while(not all(shaUnzipped)):
        unzipAPKs(shaList)
            
        # decode manifest of each unzip apk
        decodeManifest(shaList)
        
        # rename and save dex files
        pathDexFiles = renameDex(shaList,core_index)
        print(pathDexFiles)

        # import dex files on ghidra tool
        namePrj = importDex(pathDex)
        # analyze dex files on ghidra and build graphs
        AnalyzeDex(shaList,apkNoMainManager,pathDex,core_index)

        # delete project ghidra folder and DexFiles folder
        cleanFolders(namePrj,pathDexFiles)
        # delete apk and its unzip
        cleanApks(shaList)

        shaList = tongManager.pop()


    









    